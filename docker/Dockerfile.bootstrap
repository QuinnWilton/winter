# syntax=docker/dockerfile:1.4

# Lightweight bootstrap image - no SoufflÃ©, no Node.js/Claude Code

# =============================================================================
# Stage 1: Rust Builder
# =============================================================================
FROM rustlang/rust:nightly-bookworm AS builder

WORKDIR /app

# Copy dependency manifests first (maximizes cache reuse)
COPY Cargo.toml Cargo.lock ./
COPY crates/winter/Cargo.toml crates/winter/
COPY crates/winter-atproto/Cargo.toml crates/winter-atproto/
COPY crates/winter-agent/Cargo.toml crates/winter-agent/
COPY crates/winter-datalog/Cargo.toml crates/winter-datalog/
COPY crates/winter-mcp/Cargo.toml crates/winter-mcp/
COPY crates/winter-scheduler/Cargo.toml crates/winter-scheduler/
COPY crates/winter-web/Cargo.toml crates/winter-web/
COPY vendor/claude-sdk-rs/Cargo.toml vendor/claude-sdk-rs/

# Create stub files so cargo can resolve the workspace
RUN mkdir -p crates/winter/src && echo "fn main() {}" > crates/winter/src/main.rs \
    && for crate in winter-atproto winter-agent winter-datalog winter-mcp winter-scheduler winter-web; do \
         mkdir -p crates/$crate/src && echo "" > crates/$crate/src/lib.rs; \
       done \
    && mkdir -p vendor/claude-sdk-rs/src && echo "" > vendor/claude-sdk-rs/src/lib.rs

# Build dependencies only (cached via mount)
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,target=/app/target \
    cargo build --release 2>/dev/null || true

# Copy full source
COPY crates/ crates/
COPY vendor/ vendor/
COPY templates/ templates/

# Touch all source files to invalidate cached compilation from stubs
RUN find crates vendor -name "*.rs" -exec touch {} \;

# Build the actual application
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,target=/app/target \
    cargo build --release \
    && cp target/release/winter /app/winter-bin

# =============================================================================
# Stage 2: Minimal Runtime
# =============================================================================
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    ca-certificates \
    libsqlite3-0 \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/winter-bin /usr/local/bin/winter

RUN useradd -m -s /bin/bash winter
USER winter
WORKDIR /home/winter

ENTRYPOINT ["winter", "bootstrap"]
